(()=>{self.addEventListener("push",i=>{console.log("[SW] Push received:",i);let n={};try{n=i.data?i.data.json():{}}catch(e){var o;console.error("[SW] Failed to parse push data:",e),n={title:"SoundChain",body:(null===(o=i.data)||void 0===o?void 0:o.text())||"You have a new notification"}}const{title:e="SoundChain",body:t="",icon:a,badge:c,url:s,tag:r,actions:l}=n,d={body:t,icon:a||"/icons/icon-192x192.png",badge:c||"/icons/badge-72x72.png",data:{url:s||"/dex/notifications"},tag:r||"soundchain-notification",vibrate:[100,50,100],requireInteraction:!1,actions:l||[]};i.waitUntil(self.registration.showNotification(e,d))}),self.addEventListener("notificationclick",i=>{var n;console.log("[SW] Notification clicked:",i),i.notification.close();const o=(null===(n=i.notification.data)||void 0===n?void 0:n.url)||"/dex/notifications";i.action&&console.log("[SW] Action clicked:",i.action),i.waitUntil(clients.matchAll({type:"window",includeUncontrolled:!0}).then(i=>{for(const n of i)if(n.url.includes(self.location.origin)&&"focus"in n)return n.navigate(o),n.focus();if(clients.openWindow)return clients.openWindow(o)}))}),self.addEventListener("notificationclose",i=>{console.log("[SW] Notification closed:",i)});const i="soundchain-offline-queue";self.addEventListener("sync",n=>{console.log("[SW] Sync event:",n.tag),"soundchain-sync"===n.tag&&n.waitUntil(async function(){try{const n=await caches.open(i),o=await n.keys();console.log("[SW] Processing offline queue:",o.length,"items");for(const i of o)try{const o=await n.match(i);if(o){const e=await o.json();(await fetch(e.url,{method:e.method||"POST",headers:e.headers||{"Content-Type":"application/json"},body:JSON.stringify(e.body)})).ok&&(await n.delete(i),console.log("[SW] Synced offline action:",e.action))}}catch(i){console.error("[SW] Failed to sync item:",i)}}catch(i){console.error("[SW] Failed to process offline queue:",i)}}()),"soundchain-notifications-sync"===n.tag&&n.waitUntil(async function(){try{const i=await clients.matchAll();let n=null;for(const n of i);const o=await fetch("/api/notifications/pending",{headers:n?{Authorization:`Bearer ${n}`}:{}});if(o.ok){const i=await o.json();for(const n of i)await self.registration.showNotification(n.title,{body:n.body,icon:n.icon||"/icons/icon-192x192.png",badge:"/icons/badge-72x72.png",data:{url:n.url||"/dex/notifications"},tag:n.id||"pending-notification"})}}catch(i){console.error("[SW] Failed to fetch pending notifications:",i)}}())}),self.addEventListener("periodicsync",i=>{console.log("[SW] Periodic sync:",i.tag),"soundchain-check-notifications"===i.tag&&i.waitUntil(async function(){try{const i=await fetch("/api/notifications/check");if(i.ok){const n=await i.json();n.hasNew&&n.count>0&&await self.registration.showNotification("SoundChain",{body:`You have ${n.count} new notification${n.count>1?"s":""}`,icon:"/icons/icon-192x192.png",badge:"/icons/badge-72x72.png",data:{url:"/dex/notifications"},tag:"new-notifications"})}}catch(i){console.log("[SW] Background notification check failed (offline?)")}}()),"soundchain-check-rewards"===i.tag&&i.waitUntil(async function(){try{const i=await fetch("/api/rewards/check");if(i.ok){const n=await i.json();n.newRewards>0&&await self.registration.showNotification("OGUN Earned!",{body:`You earned ${n.newRewards.toFixed(2)} OGUN from streaming`,icon:"/icons/icon-192x192.png",badge:"/icons/badge-72x72.png",data:{url:"/dex/staking"},tag:"new-rewards"})}}catch(i){console.log("[SW] Background rewards check failed (offline?)")}}())}),self.addEventListener("message",n=>{console.log("[SW] Message received:",n.data);const{type:o,payload:e}=n.data||{};switch(o){case"QUEUE_OFFLINE_ACTION":!async function(n){try{const o=await caches.open(i),e=new Response(JSON.stringify(n));await o.put(`/offline-action-${Date.now()}`,e),console.log("[SW] Queued offline action:",n.action),await self.registration.sync.register("soundchain-sync")}catch(i){console.error("[SW] Failed to queue offline action:",i)}}(e);break;case"SKIP_WAITING":self.skipWaiting();break;case"REGISTER_PERIODIC_SYNC":!async function(i){try{const{tag:n,minInterval:o}=i;"periodicSync"in self.registration&&(await self.registration.periodicSync.register(n,{minInterval:o||36e5}),console.log("[SW] Registered periodic sync:",n))}catch(i){console.error("[SW] Failed to register periodic sync:",i)}}(e)}}),self.addEventListener("install",i=>{console.log("[SW] Installing SoundChain service worker..."),self.skipWaiting()}),self.addEventListener("activate",i=>{console.log("[SW] Activating SoundChain service worker..."),i.waitUntil(Promise.all([clients.claim(),(async()=>{if("periodicSync"in self.registration)try{await self.registration.periodicSync.register("soundchain-check-notifications",{minInterval:36e5}),await self.registration.periodicSync.register("soundchain-check-rewards",{minInterval:18e5}),console.log("[SW] Periodic syncs registered")}catch(i){console.log("[SW] Periodic sync not available:",i.message)}})()]))})})();